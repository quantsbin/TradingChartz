from nsepy import get_history
from datetime import date, timedelta
import pandas as pd

from tradingchartz.src.data_sourcing.nsepy_data import NSEPyData
from tradingchartz.src.backtesting.triple_barrier import TripleBarrier, TripleBarrierCalculator, TripleBarrierSetter

end_day = date.today()
start_day = end_day - timedelta(250)

def nse_stock():
        df = NSEPyData.historical_stock_close_price(symbol='SBIN',
                                                    start_date=start_day,
                                                    end_date=end_day)
        return df
# print()

# print(NSEPyData.get_symbol_list('index')['Codes'].to_list())

# print(NSEPyData.get_index_constituents('NIFTY BANK').head().T)

df = nse_stock()

df.to_csv("stock_data.csv")

import talib

output = talib.CDLDOJI(df.Open, df.High, df.Low, df.Close)
# print(df)
# print(output.head())
output = output[output.values > 0]
# output['entry_price'] = df.shift(-1).loc[output.index, 'Open']
print(output.head())

# test = output.to_frame(name='signals')
# test['entry_price'] = df.shift(-1).loc[output.index, 'Open']
# print(df.loc[date(2017, 1, 16), 'Open'])
# print(test)


triple_barrier = TripleBarrierSetter(.05, .05, 20)
triple_test = TripleBarrierCalculator(triple_barrier,
                                      df,
                                      output)

print(triple_test.df_signal_with_barrier.T)
print(triple_test.df_triple_barrier_details.T)
print(triple_test.get_triple_barrier_summary(triple_test.df_triple_barrier_details))




